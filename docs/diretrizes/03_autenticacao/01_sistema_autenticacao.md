# Sistema de Autentica√ß√£o - FASE 1

## üìã Vis√£o Geral

Este documento descreve o sistema de autentica√ß√£o implementado na **FASE 1** do projeto Or√ßaCidade, que estabelece uma base s√≥lida e segura para o controle de acesso ao sistema usando **autentica√ß√£o baseada em sess√µes**.

## üéØ Objetivos da FASE 1

### ‚úÖ Implementados:
- **Sistema de autentica√ß√£o session-based** (sem JWT)
- **Estrutura de controllers** seguindo nosso padr√£o (Web/Api)
- **Middleware de autentica√ß√£o** limpo e eficiente
- **Rotas de autentica√ß√£o** organizadas em `web.php` com prefixo `/api`
- **Prote√ß√£o de rotas** baseada em sess√£o
- **Exibi√ß√£o de dados do usu√°rio** nas interfaces
- **Sistema h√≠brido** que funciona tanto com formul√°rios quanto com API

### ‚ùå N√£o Implementados (FASE 2):
- Gerenciamento de usu√°rios
- Gerenciamento de roles/permissions
- Integra√ß√£o com Active Directory
- Funcionalidades avan√ßadas de autoriza√ß√£o

---

## üöÄ Justificativa da Nossa Abordagem

### **üéØ Por Que Escolhemos Sess√µes em Vez de JWT?**

#### **1. Seguran√ßa Superior para Aplica√ß√µes Internas**

**Sess√µes s√£o MUITO mais seguras que JWT para sistemas web internos:**

| Aspecto | Sess√µes | JWT |
|---------|---------|-----|
| **Dados sens√≠veis** | ‚ùå No servidor | ‚úÖ No cliente |
| **Modifica√ß√£o** | ‚ùå Imposs√≠vel | ‚ö†Ô∏è Poss√≠vel |
| **Invalida√ß√£o** | ‚úÖ Imediata | ‚ùå Dif√≠cil |
| **CSRF** | ‚úÖ Protegido | ‚ùå Vulner√°vel |
| **Tamanho** | ‚úÖ Pequeno | ‚ùå Grande |
| **Performance** | ‚úÖ R√°pido | ‚ùå Lento |

#### **2. Arquitetura H√≠brida Inteligente**

**Nosso sistema funciona perfeitamente para ambos os casos:**

```php
// ‚úÖ Formul√°rio HTML (redireciona)
POST /api/auth/login ‚Üí Redireciona para /home

// ‚úÖ API JSON (retorna dados)
POST /api/auth/login ‚Üí Retorna JSON com mensagem
```

**Detec√ß√£o autom√°tica:**
- **Formul√°rio HTML** ‚Üí `$request->expectsJson() = false` ‚Üí Redireciona
- **API/JavaScript** ‚Üí `$request->expectsJson() = true` ‚Üí Retorna JSON

#### **3. Simplicidade e Manutenibilidade**

**Todas as rotas em um s√≥ arquivo (`web.php`):**
- **Sem confus√£o** sobre onde colocar rotas
- **Middleware √∫nico** para autentica√ß√£o
- **Configura√ß√£o centralizada** de seguran√ßa
- **Debugging simplificado**

---

## üèóÔ∏è Arquitetura do Sistema

### **Fluxo de Autentica√ß√£o:**
```
Usu√°rio ‚Üí /login ‚Üí Web\AuthController::showLoginForm() ‚Üí Formul√°rio
Formul√°rio ‚Üí POST /api/auth/login ‚Üí Api\AuthController::login() ‚Üí Sess√£o ‚Üí /home
```

### **Prote√ß√£o de Rotas:**
```
Rota Protegida ‚Üí Middleware 'auth' ‚Üí Verifica Sess√£o ‚Üí Acesso/Redirecionamento
```

### **Estrutura H√≠brida:**
```
üìÅ Controllers:
‚îú‚îÄ‚îÄ üìÅ Web\Auth\AuthController.php (interface)
‚îî‚îÄ‚îÄ üìÅ Api\Auth\AuthController.php (dados)

 Rotas (web.php):
‚îú‚îÄ‚îÄ GET  /login           ‚Üí Mostra formul√°rio
‚îú‚îÄ‚îÄ POST /api/auth/login  ‚Üí Processa login
‚îú‚îÄ‚îÄ POST /api/auth/logout ‚Üí Processa logout
‚îî‚îÄ‚îÄ GET  /api/auth/me     ‚Üí Dados do usu√°rio
```

---

## üìÅ Estrutura de Arquivos

### **Controllers:**
```
app/Http/Controllers/
‚îú‚îÄ‚îÄ Web/
‚îÇ   ‚îî‚îÄ‚îÄ Auth/
‚îÇ       ‚îî‚îÄ‚îÄ AuthController.php          # Interface (formul√°rio)
‚îî‚îÄ‚îÄ Api/
    ‚îî‚îÄ‚îÄ Auth/
        ‚îî‚îÄ‚îÄ AuthController.php          # Dados (login/logout/me)
```

### **Middleware:**
```
app/Http/Middleware/
‚îú‚îÄ‚îÄ Authenticate.php            # Protege rotas que precisam de login
‚îî‚îÄ‚îÄ RedirectIfAuthenticated.php # Redireciona usu√°rios j√° logados
```

### **Rotas:**
```
routes/
‚îú‚îÄ‚îÄ web.php                     # TODAS as rotas (Web + API)
‚îî‚îÄ‚îÄ api.php                     # Vazio (apenas para integra√ß√£o externa)
```

### **Configura√ß√£o:**
```
config/
‚îî‚îÄ‚îÄ auth.php                    # Configura√ß√£o de autentica√ß√£o
```

---

## üîß Implementa√ß√£o T√©cnica

### **1. Controllers de Autentica√ß√£o**

#### **Web\AuthController (Interface):**
```php
class AuthController extends Controller
{
    public function showLoginForm()
    {
        // Se j√° estiver autenticado, redireciona para home
        if (Auth::check()) {
            return redirect()->route('home');
        }
        
        return view('auth.login');
    }
}
```

#### **Api\AuthController (Dados):**
```php
class AuthController extends Controller
{
    public function login(Request $request)
    {
        // Valida√ß√£o e autentica√ß√£o...
        Auth::login($user, $request->boolean('remember'));

        // Detec√ß√£o inteligente: API ou Web?
        if ($request->expectsJson()) {
            return response()->json([
                'message' => 'Login realizado com sucesso',
                'user' => $user,
                'redirect' => route('home')
            ]); // API
        }
        return redirect()->intended(route('home')); // Web
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();

        // Detec√ß√£o inteligente: API ou Web?
        if ($request->expectsJson()) {
            return response()->json([
                'message' => 'Logout realizado com sucesso'
            ]); // API
        }
        return redirect()->route('login'); // Web
    }

    public function me(Request $request)
    {
        // Sempre retorna JSON para API
        return response()->json(Auth::user());
    }
}
```

### **2. Middleware de Autentica√ß√£o**

#### **Authenticate:**
```php
protected function redirectTo(Request $request): ?string
{
    if ($request->expectsJson()) {
        return null; // API: sem redirecionamento
    }
    return route('login'); // Web: redireciona para login
}
```

#### **RedirectIfAuthenticated:**
```php
public function handle(Request $request, Closure $next, string ...$guards): Response
{
    foreach ($guards as $guard) {
        if (Auth::guard($guard)->check()) {
            if ($request->expectsJson()) {
                return response()->json([
                    'message' => 'Usu√°rio j√° autenticado',
                    'redirect' => RouteServiceProvider::HOME
                ], 400); // API: erro JSON
            }
            return redirect(RouteServiceProvider::HOME); // Web: redireciona
        }
    }
    return $next($request);
}
```

### **3. Sistema de Rotas**

#### **Rotas Web (Interface):**
```php
// P√∫blicas
GET  /                    ‚Üí P√°gina inicial
GET  /login              ‚Üí Formul√°rio de login

// Protegidas
GET  /home               ‚Üí Dashboard (protegida)
GET  /user-data          ‚Üí Dados do usu√°rio (API local)
```

#### **Rotas API (Dados):**
```php
POST /api/auth/login     ‚Üí Autentica√ß√£o (redireciona ou JSON)
POST /api/auth/logout    ‚Üí Logout (redireciona ou JSON)
GET  /api/auth/me        ‚Üí Dados do usu√°rio autenticado (JSON)
```

---

## üîß Implementa√ß√£o T√©cnica

### **1. Controllers de Autentica√ß√£o**

#### **Web\AuthController (Interface):**
```php
class AuthController extends Controller
{
    public function showLoginForm()
    {
        // Se j√° estiver autenticado, redireciona para home
        if (Auth::check()) {
            return redirect()->route('home');
        }
        
        return view('auth.login');
    }
}
```

#### **Api\AuthController (Dados):**
```php
class AuthController extends Controller
{
    public function login(Request $request)
    {
        // Valida√ß√£o e autentica√ß√£o...
        Auth::login($user, $request->boolean('remember'));

        // Detec√ß√£o inteligente: API ou Web?
        if ($request->expectsJson()) {
            return response()->json([
                'message' => 'Login realizado com sucesso',
                'user' => $user,
                'redirect' => route('home')
            ]); // API
        }
        return redirect()->intended(route('home')); // Web
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();

        // Detec√ß√£o inteligente: API ou Web?
        if ($request->expectsJson()) {
            return response()->json([
                'message' => 'Logout realizado com sucesso'
            ]); // API
        }
        return redirect()->route('login'); // Web
    }

    public function me(Request $request)
    {
        // Sempre retorna JSON para API
        return response()->json(Auth::user());
    }
}
```

### **2. Middleware de Autentica√ß√£o**

#### **Authenticate:**
```php
protected function redirectTo(Request $request): ?string
{
    if ($request->expectsJson()) {
        return null; // API: sem redirecionamento
    }
    return route('login'); // Web: redireciona para login
}
```

#### **RedirectIfAuthenticated:**
```php
public function handle(Request $request, Closure $next, string ...$guards): Response
{
    foreach ($guards as $guard) {
        if (Auth::guard($guard)->check()) {
            if ($request->expectsJson()) {
                return response()->json([
                    'message' => 'Usu√°rio j√° autenticado',
                    'redirect' => RouteServiceProvider::HOME
                ], 400); // API: erro JSON
            }
            return redirect(RouteServiceProvider::HOME); // Web: redireciona
        }
    }
    return $next($request);
}
```

---

## ‚öôÔ∏è Configura√ß√£o do Sistema

### **1. Configura√ß√£o de Autentica√ß√£o (`config/auth.php`)**

```php
<?php

return [
    'defaults' => [
        'guard' => 'web',
        'passwords' => 'users',
    ],

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
    ],

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],
    ],

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => 'password_reset_tokens',
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    'password_timeout' => 10800,
];
```

### **2. Configura√ß√£o de Sess√£o (`config/session.php`)**

```php
<?php

return [
    'driver' => env('SESSION_DRIVER', 'file'),
    'lifetime' => env('SESSION_LIFETIME', 120), // 2 horas
    'expire_on_close' => true,
    'encrypt' => false,
    'files' => storage_path('framework/sessions'),
    'connection' => env('SESSION_CONNECTION'),
    'table' => 'sessions',
    'store' => env('SESSION_STORE'),
    'lottery' => [2, 100],
    'cookie' => env(
        'SESSION_COOKIE',
        Str::slug(env('APP_NAME', 'laravel'), '_').'_session'
    ),
    'path' => '/',
    'domain' => env('SESSION_DOMAIN'),
    'secure' => env('SESSION_SECURE_COOKIE', true), // HTTPS apenas
    'http_only' => true,                            // JavaScript n√£o acessa
    'same_site' => 'lax',                           // Prote√ß√£o CSRF
];
```

### **3. Configura√ß√£o de Middleware (`app/Http/Kernel.php`)**

```php
protected $middlewareGroups = [
    'web' => [
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],

    'api' => [
        \Illuminate\Routing\Middleware\ThrottleRequests::class.':api',
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],
];

protected $routeMiddleware = [
    'auth' => \App\Http\Middleware\Authenticate::class,
    'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
    'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
];
```

---

## üîê Seguran√ßa e Por Que Sess√µes S√£o Mais Seguras

### **üõ°Ô∏è Vantagens de Seguran√ßa das Sess√µes:**

#### **1. Dados Sens√≠veis no Servidor**
```php
// ‚úÖ SESS√ÉO: Dados ficam no servidor
$_SESSION = [
    'user_id' => 123,
    'ip_address' => '192.168.1.100',
    'user_agent' => 'Mozilla/5.0...',
    'last_activity' => '2025-01-27 10:30:00'
];

// ‚ùå JWT: Dados ficam no cliente
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxMjMsImVtYWlsIjoiZXhhbXBsZUBnbWFpbC5jb20iLCJyb2xlcyI6WyJhZG1pbiJdLCJpYXQiOjE2MzI4NzY4MDAsImV4cCI6MTYzMjg4MDQwMH0.signature
```

#### **2. Invalida√ß√£o Imediata**
```php
// ‚úÖ SESS√ÉO: Logout invalida TUDO instantaneamente
Auth::logout();
$request->session()->invalidate();
$request->session()->regenerateToken();

// ‚ùå JWT: Logout n√£o invalida imediatamente
// Precisa de blacklist complexa ou esperar expira√ß√£o
```

#### **3. Prote√ß√£o CSRF Nativa**
```php
// ‚úÖ SESS√ÉO: Token CSRF √∫nico por sess√£o
<meta name="csrf-token" content="{{ csrf_token() }}">

// ‚ùå JWT: Sem prote√ß√£o CSRF nativa
// Precisa implementar manualmente
```

#### **4. Valida√ß√£o Completa no Servidor**
```php
// ‚úÖ SESS√ÉO: Laravel verifica TUDO automaticamente
- ID da sess√£o existe?
- Sess√£o n√£o expirou?
- IP √© o mesmo?
- User-Agent √© o mesmo?
- √öltima atividade √© recente?

// ‚ùå JWT: Apenas verifica assinatura e expira√ß√£o
// N√£o verifica contexto da requisi√ß√£o
```

### **üö® Cen√°rios de Ataque (Sess√£o vs JWT):**

#### **1. Ataque XSS (Cross-Site Scripting)**
```javascript
// ‚úÖ SESS√ÉO: Cookie http_only = true
// JavaScript N√ÉO consegue acessar

// ‚ùå JWT: Pode ser roubado via JavaScript
// Dados ficam expostos no localStorage/sessionStorage
```

#### **2. Ataque CSRF (Cross-Site Request Forgery)**
```javascript
// ‚úÖ SESS√ÉO: Token CSRF √∫nico
// Cada formul√°rio tem token diferente

// ‚ùå JWT: Sem prote√ß√£o nativa
// Requisi√ß√µes podem ser forjadas
```

#### **3. Roubo de Credenciais**
```javascript
// ‚úÖ SESS√ÉO: Apenas ID (in√∫til sem servidor)
// Cookie: laravel_session = "abc123def456"

// ‚ùå JWT: Dados completos do usu√°rio
// Role, permiss√µes, informa√ß√µes sens√≠veis
```

### **‚öôÔ∏è Configura√ß√µes de Seguran√ßa das Sess√µes:**

```php
// config/session.php
'secure' => env('SESSION_SECURE_COOKIE', true),     // HTTPS apenas
'http_only' => true,                                // JavaScript n√£o acessa
'same_site' => 'lax',                               // Prote√ß√£o CSRF
'expire_on_close' => true,                          // Expira ao fechar browser
'lifetime' => env('SESSION_LIFETIME', 120),         // 2 horas de inatividade
```

---

## üé® Interface do Usu√°rio

### **Header:**
- **Nome do usu√°rio** exibido dinamicamente via `/api/auth/me`
- **Data e hora** atualizadas em tempo real
- **Bot√£o de logout** funcional via formul√°rio oculto
- **Busca autom√°tica** de dados via API

### **Card Central:**
- **Sauda√ß√£o personalizada** com nome do usu√°rio
- **Data atual** em portugu√™s brasileiro
- **Hor√°rio** atualizado em tempo real
- **Status do sistema** visual

---

## üß™ Testes e Valida√ß√£o

### **Testes de Funcionalidade:**
1. **Acesso sem autentica√ß√£o** ‚Üí Redirecionamento para login
2. **Login v√°lido** ‚Üí Redirecionamento para home
3. **Acesso a rotas protegidas** ‚Üí Verifica√ß√£o de autentica√ß√£o
4. **Logout** ‚Üí Invalida√ß√£o de sess√£o
5. **Exibi√ß√£o de dados** ‚Üí Nome do usu√°rio nas interfaces

### **Testes de Seguran√ßa:**
1. **Tentativa de acesso direto** a rotas protegidas
2. **Valida√ß√£o de credenciais** inv√°lidas
3. **Prote√ß√£o contra** usu√°rios inativos
4. **Invalida√ß√£o de sess√£o** ap√≥s logout
5. **Prote√ß√£o CSRF** em formul√°rios

---

## üìä Logs e Monitoramento

### **Logs de Autentica√ß√£o:**
```php
// Exemplo de log de login
Log::info('=== IN√çCIO TENTATIVA DE LOGIN ===', [
    'email' => $request->email,
    'timestamp' => now()
]);

// Exemplo de log de sucesso
Log::info('Login bem-sucedido', [
    'user_id' => $user->id,
    'email' => $user->email
]);
```

### **Informa√ß√µes Monitoradas:**
- Tentativas de login (sucesso/falha)
- Logout de usu√°rios
- Acessos a rotas protegidas
- Erros de autentica√ß√£o
- Timestamps de todas as opera√ß√µes

---

## üöÄ Pr√≥ximos Passos (FASE 2)

### **Funcionalidades a Implementar:**
1. **Sistema RBAC** (Users, Roles, Permissions)
2. **Integra√ß√£o com Active Directory**
3. **Gerenciamento avan√ßado** de usu√°rios
4. **Controle granular** de permiss√µes
5. **Auditoria avan√ßada** de acesso

### **Arquitetura Futura:**
```
Autentica√ß√£o (FASE 1) + RBAC (FASE 2) = Sistema Completo
```

---

## üìù Notas de Implementa√ß√£o

### **Decis√µes T√©cnicas:**
- **Session-based** em vez de JWT para aplica√ß√µes internas
- **Estrutura Web/Api** seguindo nosso padr√£o documentado
- **Middleware √∫nico** para prote√ß√£o de rotas
- **Detec√ß√£o inteligente** de tipo de requisi√ß√£o
- **Todas as rotas em web.php** para simplicidade

### **Compatibilidade:**
- **Laravel 10+** compat√≠vel
- **Vue.js** integrado via componentes
- **Bootstrap** para estiliza√ß√£o
- **Responsivo** para diferentes dispositivos

---

## üîç Troubleshooting

### **Problemas Comuns e Solu√ß√µes:**

#### **1. Usu√°rio n√£o aparece no header:**
```bash
# Verificar se a rota /api/auth/me est√° funcionando
curl -X GET http://localhost/api/auth/me -H "Accept: application/json"

# Verificar logs do Laravel
tail -f storage/logs/laravel.log
```

#### **2. Logout n√£o funciona:**
```bash
# Verificar se o formul√°rio oculto est√° correto
# Deve usar: action="{{ route('api.auth.logout') }}"

# Verificar se o middleware auth est√° aplicado
# Rota deve estar dentro de Route::middleware(['auth'])
```

#### **3. Redirecionamento infinito:**
```bash
# Verificar middleware RedirectIfAuthenticated
# Deve redirecionar usu√°rios logados para /home

# Verificar se a rota /home existe e est√° protegida
php artisan route:list | grep home
```

#### **4. Sess√£o perdida frequentemente:**
```bash
# Verificar configura√ß√µes de sess√£o
php artisan config:show session

# Verificar permiss√µes da pasta storage
chmod -R 775 storage/framework/sessions

# Verificar se o driver de sess√£o est√° funcionando
php artisan session:table
php artisan migrate
```

#### **5. Erro CSRF Token:**
```bash
# Verificar se o token est√° sendo enviado
# Formul√°rio deve ter: @csrf

# Verificar se a sess√£o est√° funcionando
php artisan session:status

# Limpar cache de configura√ß√£o
php artisan config:clear
```

#### **6. Problemas de Performance:**
```bash
# Verificar se as sess√µes est√£o sendo limpas
php artisan session:gc

# Verificar tamanho da pasta de sess√µes
du -sh storage/framework/sessions

# Configurar limpeza autom√°tica no cron
# Adicionar ao crontab: * * * * * php /path/to/artisan session:gc
```

### **Comandos √öteis para Debug:**

```bash
# Listar todas as rotas
php artisan route:list

# Verificar status da autentica√ß√£o
php artisan tinker
>>> Auth::check()

# Verificar configura√ß√µes
php artisan config:show auth
php artisan config:show session

# Limpar caches
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Verificar logs em tempo real
tail -f storage/logs/laravel.log
```

---

## üìö Refer√™ncias

### **Documenta√ß√£o Laravel:**
- [Authentication](https://laravel.com/docs/authentication)
- [Middleware](https://laravel.com/docs/middleware)
- [Session](https://laravel.com/docs/session)

### **Padr√µes Utilizados:**
- **MVC** (Model-View-Controller)
- **Middleware Pattern**
- **Session-based Authentication**
- **RESTful API Design**
- **Hybrid Web/API Architecture**

---

## üéØ Conclus√£o

### **‚úÖ Nossa Abordagem √© Superior Porque:**

1. **Seguran√ßa M√°xima** - Dados sens√≠veis no servidor
2. **Simplicidade** - Todas as rotas em um arquivo
3. **Flexibilidade** - Funciona com formul√°rios e API
4. **Manutenibilidade** - Estrutura clara e organizada
5. **Performance** - Sess√µes s√£o mais r√°pidas que JWT
6. **Padr√£o Laravel** - Usa recursos nativos do framework

### **üöÄ Resultado Final:**
**Um sistema de autentica√ß√£o robusto, seguro e flex√≠vel que segue 100% nossos padr√µes documentados e oferece seguran√ßa superior √†s alternativas JWT.**

---

**üìÖ Data de Cria√ß√£o:** 27/01/2025  
**üë®‚Äçüíª Desenvolvedor:** Sistema de Autentica√ß√£o - FASE 1  
**üè∑Ô∏è Vers√£o:** 2.0.0  
**üìã Status:** ‚úÖ IMPLEMENTADO, TESTADO E FUNCIONANDO  
**üîí Seguran√ßa:** ‚úÖ SUPERIOR A JWT PARA APLICA√á√ïES INTERNAS
